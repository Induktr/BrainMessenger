# Документация звуков (Audio Guide)

### Документация звуков (Audio Guide) для BrainMessenger

### 1. Введение

**Название проекта:** BrainMessenger

**Описание:** Документ описывает звуковую систему BrainMessenger, включая звуки уведомлений, звонков (входящих и исходящих), а также другие интерактивные звуки, которые улучшают пользовательский опыт.

**Цель:** Обеспечить единообразный аудио-опыт на всех платформах (Android, Windows, веб), улучшить восприятие приложения и уведомить пользователей о важных событиях (сообщения, звонки).

**Текущий статус:** Звуки планируются для внедрения в v1.0 (Q4 2025), с возможностью настройки в Q2 2026 (см. Дорожную карту).

---

### 2. Цели звуковой системы

- **Уведомления:** Информировать пользователей о новых сообщениях, звонках и событиях.
- **Интерактивность:** Улучшить восприятие действий (например, отправка сообщения, нажатие кнопки).
- **Персонализация:** Дать пользователям возможность настраивать звуки (например, выбор мелодии для звонков).
- **Доступность:** Учитывать пользователей с ограничениями (например, вибрация вместо звука).

---

### 3. Категории звуков

Звуки BrainMessenger разделены на категории в зависимости от их назначения. Все звуки должны быть короткими (до 5 секунд), ненавязчивыми и соответствовать бренду (минимализм, технологичность, интеллектуальность).

| Категория            | Назначение               | Пример события               | Длительность   | Формат |
|----------------------|--------------------------|------------------------------|----------------|--------|
| **Уведомления**      | Оповещение о новых событиях | Новое сообщение, упоминание | 1-2 сек        | MP3    |
| **Входящие звонки**  | Сигнал о входящем звонке | Входящий аудио/видеозвонок  | 3-5 сек (loop) | MP3    |
| **Исходящие звонки** | Сигнал ожидания ответа | Исходящий аудио/видеозвонок | 3-5 сек (loop) | MP3    |
| **Интерактивные звуки** | Подтверждение действий | Отправка сообщения, нажатие кнопки | 0.5-1 сек | MP3    |
| **Системные звуки**  | Важные системные события | Ошибка, низкий заряд батареи | 1-2 сек      | MP3    |

---

### 4. Список звуков

Ниже приведены конкретные звуки, их описание и назначение. Все звуки должны быть записаны в формате MP3 (битрейт 128 kbps) для оптимального размера и качества.

| Название звука      | Категория            | Описание                              | Файл                  | Настройки пользователя      |
|---------------------|----------------------|---------------------------------------|-----------------------|-----------------------------|
| `message_received`  | Уведомления          | Короткий звук для нового сообщения    | `message_received.mp3` | Выбор мелодии, вкл/выкл     |
| `mention_alert`     | Уведомления          | Более акцентированный звук для упоминаний | `mention_alert.mp3` | Выбор мелодии, вкл/выкл     |
| `incoming_call`     | Входящие звонки      | Мелодия для входящего звонка          | `incoming_call.mp3`   | Выбор мелодии, громкость    |
| `outgoing_call`     | Исходящие звонки     | Звук ожидания ответа               | `outgoing_call.mp3`   | Выбор мелодии, громкость    |
| `message_sent`      | Интерактивные звуки  | Подтверждение отправки сообщения      | `message_sent.mp3`    | Вкл/выкл                    |
| `button_click`      | Интерактивные звуки  | Звук нажатия на кнопку                | `button_click.mp3`    | Вкл/выкл                    |
| `error_alert`       | Системные звуки      | Оповещение об ошибке (например, сбой)  | `error_alert.mp3`     | Вкл/выкл                    |
| `low_battery`       | Системные звуки      | Предупреждение о низком заряде        | `low_battery.mp3`     | Вкл/выкл                    |
| `call_ended`        | Звонки               | Короткий звук при завершении звонка (пользователь "кладёт трубку") | `call_ended.mp3` | Вкл/выкл, громкость         |

---

### 5. Техническая реализация

#### 5.1. Хранение звуков

- Звуки хранятся в Cloudflare R2 (см. Руководство по развертыванию).
- Путь: `https://<account-id>.r2.cloudflarestorage.com/brainmessenger-files/audio/`.
- Пример:
  ```
  https://<account-id>.r2.cloudflarestorage.com/brainmessenger-files/audio/message_received.mp3
  ```
- Для экономии места звуки сжимаются (битрейт 128 kbps).

#### 5.2. Интеграция в код

- **Мобильные (Android) и Десктоп (Windows):** Используется библиотека `react-native-sound` для воспроизведения звуков в React Native.
  ```jsx
  import Sound from 'react-native-sound'

  const playSound = (soundUrl) => {
    const sound = new Sound(soundUrl, '', (error) => {
      if (error) {
        console.log('Failed to load sound', error)
        return
      }
      sound.play()
    })
  }

  // Пример: воспроизведение звука нового сообщения
  playSound('https://<account-id>.r2.cloudflarestorage.com/brainmessenger-files/audio/message_received.mp3')
  ```
- **Веб:** Используется HTML5 Audio API в Next.js.
  ```jsx
  // web/utils/playSound.ts
  const playSound = (soundFile) => {
    const audio = new Audio(`https://<account-id>.r2.cloudflarestorage.com/brainmessenger-files/audio/${soundFile}`)
    audio.play().catch((error) => console.log('Failed to play sound', error))
  }

  // Пример: воспроизведение звука нового сообщения
  playSound('message_received.mp3')
  ```
- **Предзагрузка:** Звуки предзагружаются для минимизации задержек.
  ```jsx
  // Предзагрузка для React Native
  const preloadSounds = () => {
    [
      'https://<account-id>.r2.cloudflarestorage.com/brainmessenger-files/audio/message_received.mp3',
      'https://<account-id>.r2.cloudflarestorage.com/brainmessenger-files/audio/incoming_call.mp3'
    ].forEach((url) => {
      new Sound(url, '')
    })
  }
  ```

#### 5.3. Настройка пользователя

- Звуки интегрируются с настройками приложения ("Battery & Animations").
- Пример структуры настроек:
  ```json
  {
    "sounds": {
      "notifications": {
        "message_received": { "enabled": true, "file": "message_received.mp3" },
        "mention_alert": { "enabled": true, "file": "mention_alert.mp3" }
      },
      "calls": {
        "incoming_call": { "enabled": true, "file": "incoming_call.mp3", "volume": 0.8 },
        "outgoing_call": { "enabled": true, "file": "outgoing_call.mp3", "volume": 0.8 }
      },
      "interactive": {
        "message_sent": { "enabled": false },
        "button_click": { "enabled": false }
      }
    }
  }
  ```
- Пользователь может включать/выключать звуки и выбирать мелодии (Q2 2026).

#### 5.4. Доступность

- Для пользователей с ограничениями слуха звуки дублируются вибрацией.
  ```jsx
  import { Vibration } from 'react-native'

  const notifyWithSoundAndVibration = (soundUrl) => {
    playSound(soundUrl)
    Vibration.vibrate([0, 500]) // 500 мс вибрация
  }
  ```

---

### 6. Тестирование

- **Сценарии:**
  - Звук воспроизводится при новом сообщении (<1 сек задержка).
  - Звук входящего звонка зацикливается до ответа.
  - Отключение звука в настройках работает корректно.
- **Инструменты:**
  - Detox (мобильные) и Cypress (веб) для E2E-тестов.
  - Пример теста:
    ```jsx
    it('plays message received sound', () => {
      cy.get('[data-testid="new-message"]').click()
      cy.get('[data-testid="sound-player"]').should('have.attr', 'src', 'message_received.mp3')
    })
    ```

---

### 7. Риски и их минимизация

| Риск                  | Вероятность | Последствия         | Решение                     |
|-----------------------|-------------|---------------------|-----------------------------|
| Задержка воспроизведения | Средняя     | Плохой UX           | Предзагрузка звуков         |
| Несовместимость платформ | Низкая      | Звук не воспроизводится | Тестирование на Android, Windows, веб |
| Перегрузка памяти     | Низкая      | Задержки в приложении | Использование MP3, битрейт 128 kbps |

---

### 8. Примечания

- **График:** Звуки внедряются в Q4 2025, настройка — в Q2 2026.
- **Ресурсы:** Нанять звукового дизайнера для создания уникальных мелодий.
- **Будущее:** Добавить поддержку пользовательских звуков (Q3 2026).

---

### Итог изменений
- **AWS S3** заменён на **Cloudflare R2** в разделе 5.1 (Хранение звуков).
- Обновлены пути к звуковым файлам в примерах кода в разделе 5.2 (Интеграция в код), заменив `s3://` на URL Cloudflare R2.
- Удалены упоминания других сервисов AWS.
- Сохранена вся структура документации, включая заголовки, подзаголовки и форматирование.