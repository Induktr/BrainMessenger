# Руководство по безопасности BrainMessenger

### 1. Введение

**Название проекта:** BrainMessenger

**Описание:** Руководство определяет подходы к обеспечению безопасности мессенджера BrainMessenger, включая шифрование, аутентификацию, защиту от атак и план реагирования на инциденты.

**Цель:** Защитить данные пользователей, предотвратить утечки и обеспечить надёжность системы при масштабировании до 1 миллиона активных пользователей.

---

### 2. Основные принципы безопасности

- **Конфиденциальность:** Данные доступны только авторизованным лицам.
- **Целостность:** Данные не могут быть изменены без разрешения.
- **Доступность:** Система работает стабильно даже под нагрузкой или атаками.
- **Соответствие:** Учёт требований GDPR, CCPA и других стандартов.

---

### 3. Методы защиты

### 3.1. Шифрование

- **Передача данных:**
    - Протокол: TLS 1.2+ (SSL-сертификаты от Let’s Encrypt или аналогичного CA).
    - Использование: Все соединения (API, звонки, файлы) через HTTPS.
- **Хранение данных:**
    - Сообщения: Шифрование AES-256 в базе данных.
    - Пароли: Хеширование с bcrypt (соль, 12 раундов).
    - Ключи: Хранятся в безопасном хранилище (например, AWS Secrets Manager).

### 3.2. Аутентификация

- **JWT:**
    - Токены: Выдаются при входе, срок действия 24 часа.
    - Обновление: Refresh-токены с TTL 7 дней.
    - Подпись: HMAC-SHA256 с секретным ключом (`JWT_SECRET`).
- **OAuth 2.0:** Поддержка входа через Gmail (опционально).
- **Двухфакторная аутентификация (2FA):**
    - Метод: 8-значный код, отправляемый на email.
    - TTL: 10 минут.
    - Хранение: Временное в Redis с хешированием.

### 3.3. Защита от атак

- **SQL-инъекции:**
    - Использование параметризованных запросов в PostgreSQL.
- **XSS (межсайтовый скриптинг):**
    - Экранирование ввода на фронтенде (React) и бэкенде (NestJS).
- **DDoS:**
    - Балансировка нагрузки через Kubernetes.
    - Ограничение скорости запросов (rate limiting): 100 запросов/мин на IP.
- **Перебор паролей:**
    - Лимит попыток: 5 за 5 минут → Блокировка IP на 60 секунд.

### 3.4. Доступ к системе

- **Роли:**
    - Пользователь: Доступ только к своим данным.
    - Администратор: Полный доступ (через отдельный интерфейс).
- **Контроль:** Логирование всех действий (без персональных данных).

---

### 4. Обработка данных пользователей

- **Сбор:** Только необходимые данные (email, имя, пароль).
- **Хранение:**
    - Личные данные: В PostgreSQL с шифрованием.
    - Временные данные (коды 2FA): В Redis с TTL 10 минут.
- **Удаление:**
    - При удалении аккаунта: Полная очистка данных пользователя из базы в течение 30 дней (GDPR).
- **Резервное копирование:**
    - Ежедневные бэкапы с шифрованием AES-256.
    - Хранение: Отдельный защищённый сервер (например, AWS S3).

---

### 5. Обработка ошибок

- **Некорректный ввод:**
    - Пример: Неверный пароль → Сообщение "Неверный пароль", без указания причины.
- **Сетевые сбои:**
    - Пример: "Проверьте подключение" при отсутствии ответа сервера.
- **Лимиты:**
    - 5 неверных кодов 2FA → Блокировка ввода на 60 секунд.
- **Логирование:** Ошибки записываются без чувствительных данных (например, IP, но не пароли).

---

### 6. Мониторинг безопасности

- **Инструменты:**
    - Sentry: Отслеживание ошибок и аномалий.
    - Prometheus/Grafana: Мониторинг подозрительной активности (например, >1000 запросов/мин с IP).
- **Метрики:**
    - Количество неудачных попыток входа.
    - Частота ошибок 403/429 (доступ запрещён/лимит превышен).
- **Оповещения:**
    - Уведомления через email/Slack при >5% ошибок за 5 минут.

---

### 7. План реагирования на инциденты

### 7.1. Типы инцидентов

- Утечка данных.
- DDoS-атака.
- Сбой сервера.

### 7.2. Шаги

1. **Обнаружение:** Мониторинг фиксирует аномалию (например, рост ошибок 500).
2. **Оценка:**
    - Кто: Команда безопасности.
    - Что: Анализ логов и метрик (ELK Stack, Sentry).
3. **Реакция:**
    - Утечка: Блокировка доступа, уведомление пользователей в течение 72 часов (GDPR).
    - DDoS: Увеличение лимитов через балансировщик, блокировка IP-атакующих.
    - Сбой: Переключение на резервный сервер, восстановление из бэкапа.
4. **Уведомление:**
    - Пользователи: Через email при утечке.
    - Команда: Через Slack для всех инцидентов.
5. **Анализ:** Отчёт с причинами и мерами предотвращения.

### 7.3. Контакты

- **Ответственный:** Security Lead ([security@brainmessenger.com](mailto:security@brainmessenger.com)).
- **Срочная связь:** Телефон внутренней команды (указать номер).

---

### 8. Рекомендации для разработчиков

- **API:** Все запросы через HTTPS, валидация данных на сервере.
- **Фронтенд:** Экранирование пользовательского ввода (например, через DOMPurify).
- **Бэкенд:** Использование ORM (TypeORM) для защиты от инъекций.
- **Конфигурация:** Хранение ключей в `.env`, запрет их коммита в Git.

---

### 9. Соответствие стандартам

- **GDPR:**
    - Согласие на обработку данных при регистрации.
    - Право на удаление данных (FR-8).
- **CCPA:** Уведомление о сборе данных в политике конфиденциальности.
- **ISO 27001:** Рекомендации по шифрованию и мониторингу.

---

### 10. Примечания

- **Тестирование:** Регулярные проверки на уязвимости (ежеквартально с OWASP ZAP).
- **Обновления:** Поддержка только TLS 1.2+ (C-4), отказ от устаревших протоколов.
- **Аудит:** Внешний аудит безопасности перед релизом и ежегодно.