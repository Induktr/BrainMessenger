# Руководство по безопасности BrainMessenger

### 1. Введение

**Название проекта:** BrainMessenger  
**Описание:** Руководство определяет подходы к обеспечению безопасности мессенджера BrainMessenger, включая шифрование, аутентификацию, защиту от атак, выбор инструментов для работы с базой данных и план реагирования на инциденты.  
**Цель:** Защитить данные пользователей, предотвратить утечки и обеспечить надёжность системы при масштабировании до 1 миллиона активных пользователей.  

---

### 2. Основные принципы безопасности

- **Конфиденциальность:** Данные доступны только авторизованным лицам.  
- **Целостность:** Данные не могут быть изменены без разрешения.  
- **Доступность:** Система работает стабильно даже под нагрузкой или атаками.  
- **Соответствие:** Учёт требований GDPR, CCPA и других стандартов.  

---

### 3. Методы защиты

#### 3.1. Шифрование

- **Передача данных:**  
  - Протокол: TLS 1.2+ (SSL-сертификаты от Let’s Encrypt или аналогичного CA).  
  - Использование: Все соединения (API, звонки, файлы) через HTTPS.  
- **Хранение данных:**  
  - Сообщения: Шифрование AES-256 в базе данных.  
  - Пароли: Хеширование с bcrypt (соль, 12 раундов).  
  - Ключи: Хранятся в безопасном хранилище (например, HashiCorp Vault).  

#### 3.2. Аутентификация

- **JWT:**  
  - Токены: Выдаются при входе, срок действия 24 часа.  
  - Обновление: Refresh-токены с TTL 7 дней.  
  - Подпись: HMAC-SHA256 с секретным ключом (`JWT_SECRET`).  
- **OAuth 2.0:** Поддержка входа через Gmail (опционально).  
- **Двухфакторная аутентификация (2FA):**  
  - Метод: 8-значный код, отправляемый на email.  
  - TTL: 10 минут.  
  - Хранение: Временное в Redis с хешированием.  

#### 3.3. Защита от атак

- **SQL-инъекции:**  
  - Использование Prisma для параметризованных запросов в PostgreSQL, что минимизирует риск инъекций.  
  - Пример:  
    ```typescript
    const user = await prisma.user.findUnique({
      where: { email: 'user@example.com' },
    })
    ```
- **XSS (межсайтовый скриптинг):**  
  - Экранирование ввода на фронтенде (React) и бэкенде (NestJS).  
- **DDoS:**  
  - Балансировка нагрузки через Kubernetes.  
  - Ограничение скорости запросов (rate limiting): 100 запросов/мин на IP.  
- **Перебор паролей:**  
  - Лимит попыток: 5 за 5 минут → Блокировка IP на 60 секунд.  

#### 3.4. Доступ к системе

- **Роли:**  
  - Пользователь: Доступ только к своим данным.  
  - Администратор: Полный доступ (через отдельный интерфейс).  
- **Контроль:** Логирование всех действий (без персональных данных).  

---

### 4. Обработка данных пользователей

- **Сбор:** Только необходимые данные (email, имя, пароль).  
- **Хранение:**  
  - Личные данные: В PostgreSQL с шифрованием (AES-256).  
  - Временные данные (коды 2FA): В Redis с TTL 10 минут.  
- **Удаление:**  
  - При удалении аккаунта: Полная очистка данных пользователя из базы в течение 30 дней (GDPR).  
  - Использование Prisma для безопасного удаления:  
    ```typescript
    await prisma.user.delete({
      where: { id: userId },
    })
    ```
- **Резервное копирование:**  
  - Ежедневные бэкапы с шифрованием AES-256.  
  - Хранение: Cloudflare R2 с ограничением доступа.  

---

### 5. Выбор ORM для обеспечения безопасности и надёжности

Для управления взаимодействием с базой данных (PostgreSQL через Neon) в BrainMessenger используется **Prisma** как основной ORM-инструмент. Этот выбор обусловлен следующими факторами, связанными с безопасностью и надёжностью:

- **Полная типобезопасность:**  
  Prisma генерирует типизированный клиент (Prisma Client) на основе файла `schema.prisma`, что позволяет TypeScript выявлять ошибки на этапе компиляции. Это снижает риск уязвимостей, связанных с некорректными запросами (например, фильтрация данных пользователей).  
  - Пример:  
    ```typescript
    const user = await prisma.user.findUnique({
      where: { email: 'user@example.com' },
    })
    ```
    Здесь Prisma гарантирует, что `email` — строка, и предотвращает ошибки, которые могли бы привести к утечке данных.

- **Защита от SQL-инъекций:**  
  Prisma автоматически параметризует все запросы, минимизируя риск SQL-инъекций. Даже при использовании сырых SQL-запросов (через `prisma.$queryRaw`) Prisma поддерживает типобезопасность, что снижает вероятность ошибок.  
  - Пример:  
    ```typescript
    const email = 'user@example.com'
    const users = await prisma.$queryRaw`SELECT * FROM "User" WHERE email = ${email}`
    ```
    Prisma автоматически экранирует `email`, предотвращая инъекции.

- **Надёжные миграции:**  
  Prisma Migrate использует декларативный подход, который позволяет предварительно просматривать изменения схемы перед их применением. Это снижает риск потери данных или несоответствия схемы, что критически важно для безопасности пользовательских данных (например, сообщений, медиафайлов).  
  - Пример команды:  
    ```bash
    npx prisma migrate dev --name add-user-table --preview
    ```

- **Активная поддержка:**  
  Prisma активно развивается, имеет большое сообщество и финансовую поддержку, что гарантирует своевременное исправление уязвимостей и багов. Это особенно важно для долгосрочного проекта, такого как BrainMessenger, который планируется монетизировать и поддерживать в течение многих лет.

- **Альтернатива (TypeORM):**  
  TypeORM рассматривался как альтернатива, но был отклонён по следующим причинам:  
  - Ограниченная типобезопасность увеличивает риск ошибок, которые могут стать уязвимостями.  
  - Множество нерешённых багов (1.1k на 2023 год) и замедленное развитие проекта создают риски для долгосрочной поддержки.  
  - Ручное управление миграциями менее надёжно и может привести к ошибкам, особенно при частых изменениях схемы.

#### 5.1. Рекомендации по использованию Prisma
- **Регулярное обновление:** Следите за обновлениями Prisma (выпускаются каждые 3 недели) и применяйте их, чтобы получать последние исправления безопасности.  
- **Проверка миграций:** Всегда используйте предварительный просмотр миграций (`--preview`) перед применением изменений в продакшене.  
- **Мониторинг ошибок:** Интегрируйте Prisma с Sentry (уже используется в BrainMessenger) для отслеживания ошибок, связанных с базой данных.  
- **Шифрование данных:** Для чувствительных данных (например, паролей) используйте шифрование на уровне приложения (например, bcrypt), так as Prisma не предоставляет встроенных механизмов шифрования.  

---

### 6. Обработка ошибок

- **Некорректный ввод:**  
  - Пример: Неверный пароль → Сообщение "Неверный пароль", без указания причины.  
- **Сетевые сбои:**  
  - Пример: "Проверьте подключение" при отсутствии ответа сервера.  
- **Лимиты:**  
  - 5 неверных кодов 2FA → Блокировка ввода на 60 секунд.  
- **Логирование:** Ошибки записываются без чувствительных данных (например, IP, но не пароли).  

---

### 7. Мониторинг безопасности

- **Инструменты:**  
  - Sentry: Отслеживание ошибок и аномалий, включая ошибки Prisma (например, "Database connection failed").  
  - Prometheus/Grafana: Мониторинг подозрительной активности (например, >1000 запросов/мин с IP).  
- **Метрики:**  
  - Количество неудачных попыток входа.  
  - Частота ошибок 403/429 (доступ запрещён/лимит превышен).  
  - Количество ошибок базы данных (например, "Unique constraint violation").  
- **Оповещения:**  
  - Уведомления через email/Slack при >5% ошибок за 5 минут.  

---

### 8. План реагирования на инциденты

#### 8.1. Типы инцидентов
- Утечка данных.  
- DDoS-атака.  
- Сбой сервера.  
- Ошибка базы данных (например, несоответствие схемы).  

#### 8.2. Шаги
1. **Обнаружение:** Мониторинг фиксирует аномалию (например, рост ошибок 500 или "Prisma: Connection timeout").  
2. **Оценка:**  
   - Кто: Команда безопасности.  
   - Что: Анализ логов и метрик (ELK Stack, Sentry).  
3. **Реакция:**  
   - Утечка: Блокировка доступа, уведомление пользователей в течение 72 часов (GDPR).  
   - DDoS: Увеличение лимитов через балансировщик, блокировка IP-атакующих.  
   - Сбой: Переключение на резервный сервер, восстановление из бэкапа.  
   - Ошибка базы данных: Проверка миграций через Prisma Migrate, откат изменений при необходимости.  
4. **Уведомление:**  
   - Пользователи: Через email при утечке.  
   - Команда: Через Slack для всех инцидентов.  
5. **Анализ:** Отчёт с причинами и мерами предотвращения.  

#### 8.3. Контакты
- **Ответственный:** Security Lead ([security@brainmessenger.com](mailto:security@brainmessenger.com)).  
- **Срочная связь:** Телефон внутренней команды (указать номер).  

---

### 9. Рекомендации для разработчиков

- **API:** Все запросы через HTTPS, валидация данных на сервере.  
- **Фронтенд:** Экранирование пользовательского ввода (например, через DOMPurify).  
- **Бэкенд:** Использование Prisma для защиты от SQL-инъекций.  
  - Пример безопасного запроса:  
    ```typescript
    const user = await prisma.user.findFirst({
      where: { email: emailInput },
    })
    ```
- **Конфигурация:** Хранение ключей в `.env`, запрет их коммита в Git.  
  - Пример:  
    ```env
    NEON_DATABASE_URL="postgresql://user:password@neon-host:port/brainmessenger"
    JWT_SECRET="your-secure-secret"
    ```
- **Prisma:**  
  - Используйте только параметризованные запросы.  
  - Регулярно обновляйте Prisma для получения исправлений безопасности.  
  - Настройте логирование ошибок Prisma через Sentry.  

---

### 10. Соответствие стандартам

- **GDPR:**  
  - Согласие на обработку данных при регистрации.  
  - Право на удаление данных (FR-8).  
  - Безопасное удаление через Prisma:  
    ```typescript
    await prisma.user.deleteMany({
      where: { deletedAt: { lte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) } },
    })
    ```
- **CCPA:** Уведомление о сборе данных в политике конфиденциальности.  
- **ISO 27001:** Рекомендации по шифрованию и мониторингу.  

---

### 11. Примечания

- **Тестирование:** Регулярные проверки на уязвимости (ежеквартально с OWASP ZAP).  
- **Обновления:** Поддержка только TLS 1.2+ (C-4), отказ от устаревших протоколов.  
- **Аудит:** Внешний аудит безопасности перед релизом и ежегодно.  
- **Prisma:** Регулярно проверяйте обновления Prisma и применяйте их для устранения потенциальных уязвимостей.  